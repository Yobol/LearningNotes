# TSL 1.3传输加密协议详解

> Internet Engineering  Task Force(IETF) - [RFC: 8446 TLS](https://www.rfc-editor.org/rfc/pdfrfc/rfc8446.txt.pdf)

TSL（Transport Layer Security Protocol，安全传输层协议）能够有效防止数据在传输过程中被窃听、篡改和伪造，以支持 C/S 应用程序在因特网上进行安全通信。

## 简介

TLS 主要目的是**在两个通信对等实体之间提供安全通道**，对下层传输层的唯一要求是**可靠的有序数据流**。

TLS / 安全通道需要满足一下的特性：

- 提供身份认证方式：

  - 服务器始终要经过身份认证，客户端则可根据应用场景自主选择是否要进行身份认证；

  - 认证可以选择非对称加密算法（例如 RSA，ECDSA， EdDSA），或者对称预共享键算法（PSK）。

    `DSA: Digital Signature Algorithm.`

- 支持数据加密：

  - 在通道上传输的数据只对另一端可见；
  - TLS 不会隐藏传输数据的长度（通道两端的通信结点可以**填充 TLS 记录**以掩盖原始数据的长度，增强对流量分析技术的防护）。

- 保证传输数据的完整性：

  - 在通道上传输的数据不能被随意篡改。

TLS 主要由两部分组成：

- 握手协议：
  - 对通信双方进行身份认证，协商加密模式和参数，建立共享的秘钥资料；
  - 握手协议用来防止数据被篡改：攻击者不能强迫通信双方协商更改加密参数。
- 记录协议：
  - 使用握手过程建立的加密参数保护通信双方之间的流量（traffic，通信量）；
  - 将流量分成若干记录，每个记录使用流量密钥独立保护。

TLS 是独立的应用层协议，更高级别的协议（如HTTPS）可以透明地在 TLS 之上分层。 TLS 标准没有指定协议如何使用 TLS 添加安全性； 如何初始化 TLS 握手过程以及如何解析交换的身份认证证书（由运行在 TLS 之上的协议设计者和实现者决定）。

TLS 1.3 没有向前兼容，TLS 的所有版本都包含一个版本控制机制，该机制允许客户端和服务器共同协商一个双方都支持的通用版本。

### 术语

- 终端（endpoint）：通信终端，连接的客户端或者服务器；
- 连接（connection）：在两个通信终端之间建立的传输层连接；
- 握手（handshake）：在客户端和服务器之间建立后续交互参数的启动协商过程；
- 客户端（client）：启动 TLS 连接的通信终端；
- 服务器（server）：被动接受 TLS 连接的通信终端；
- 对等方（peer）：即endpoint，当讨论特定的通信终端时，peer指代另一类通信终端（如当前语境下endpoint指代server时，peer则指代client）；
- 接收者（receiver）：接受记录的通信终端；
- 发送者（sender）：发送记录的通信终端。

### 和 TLS 1.2 的主要区别

- 移除了 TLS 1.2 支持的一系列认为是遗留的对称加密算法，留下的都是带有关联数据的身份验证加密（AEAD）算法；更改了密码套件（the cipher suite）概念：将“授权和密钥交换机制”与“记录保护机制（包括密钥长度）”和“用于密钥派生函数和握手消息认证码（MAC)的哈希”独立开；
- 增加零往返时间（0-RTT）模式，以某些安全属性为代价在某些应用程序数据建立连接时节省了往返时间；
- 移除静态 RSA 和 Diffie-Hellman 密码套件；所有基于公钥的密钥交换机制现在都提供向前保密性；
- 在服务器发送 `ServerHello` 后的所有的握手消息现在都会被加密；新引入的 `EncryptedExtensions` 消息允许之前在 `ServerHello` 中以明文形式（in the clear）被发送的各种扩展也可以享受加密保护；
- 重新设计了秘钥派生函数：新的设计让密码学家设计加密方式更容易，由于改进了密钥分离特性（见第一点）；基于 HMAC（Handshake Meesage Authentication Code）的 提取和扩展密钥派生函数（HKDF，HMAC-based Extract-and-Expand Key Derivation Function）被作为基础原语使用；
- 握手状态机已经完成重组以更加一致；移除不必要的消息，例如 `ChangeCipherSpec`；
- ECDSA 算法已列入基本规格，并且加入了新的数字签名算法，如 EdDSA；TLS 1.3删除了点格式协商，转而支持每条曲线的单点格式；
- 还做了一些加密算法上的改进：改变 RSA 填充以使用 RSA 概率签名方案；移除压缩、数字签名算法（DSA)，和自定义的 Ephemeral Diffle-Hellman（DHE）组；
- 为了支持扩展中的版本列表，不建议使用TLS 1.2版本协商机制；这增加了那些现存的没有正确实现版本协商的服务器的兼容性；
- 具有和不具有服务器端状态的会话恢复以及早期 TLS 版本的基于 PSK 密码套件已经被单一新 PSK 交换所替代；

### 影响 TLS 1.2 的更新

- 版本降级保护机制；
- RSASSA-PSS 签名方案；
- ClientHello 扩展的 `supported_versions` 能够被用于协商使用的 TLS 版本，优先于 ClientHello 的 `legacy_version` 字段。

## 协议概述

TLS 握手协议会生成用于建立安全通道的密码参数，客户端和服务器使用该协议建立首次连接。握手协议允许通信双方协商协议版本，选择加密算法，根据应用场景决定是否进行身份认证，以及建立密钥资料（secret keying material）。一旦通信双方完成握手过程，就会使用建立的密钥保护应用层流量（traffic，传输的数据）。

握手失败或者其它协议错误将导致连接中断，并可以选择是否在中断发生后发送告警消息（alert message）。

TLS 支持三种基本的密钥交换模式：

- （EC）DHE（Diffie-Hellman over either finite fields or elliptic curves）；
- PSK-only；
- PSK with （EC）DHE。

TLS 完整的握手过程如下图所示：



### 不正确的 DHE 共享

### 恢复与预共享键

### 0-RTT 数据

## 表现语言

### 基础块大小

### 杂项

### 数字

### 向量

### 构造类型

### 常量

### 变量

## 握手协议

### 键互换消息

#### 加密协商

#### 客户端问候

#### 服务器问候

#### 问候重试请求

### 扩展

