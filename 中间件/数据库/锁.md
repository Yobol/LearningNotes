# 锁

## 锁的种类

- 按照锁的粒度：表级锁、行级锁和页级锁，表级锁会锁住整张表即使仅操作表中的一条数据；
- 按照锁的级别：共享锁（读锁，lock in share mode）和排他锁（写锁，for update），写锁会阻塞所有读写操作；
- 按照加锁方式：自动锁、显示锁（需要手动上的锁）；
- 按照操作：DML锁（对表中的数据进行操作时加的锁）、DDL锁（对表的结构进行变更时加的锁）；
- 按照使用方式：悲观锁（排他锁）、乐观锁（版本号）；

![1574352671930](assets/1574352671930.png)

## MyISAM与InnoDB关于锁方面的区别是什么

- MyISAM默认使用表级锁，不支持行级锁：

  - 当进行select时，MyISAM引擎会自动为整张表加上读锁，而d当进行增删改时，自动为整张表加上写锁。

  ```mysql
  lock tables t_trade read; # 给t_trade表加上读锁
  unlock tables; # 解锁
  ```

- InnoDB默认使用的是行级锁，支持表级锁；

- InnoDB使用的是二段锁：

  - 加锁和解锁分为两个步骤进行，即先对同一事务里的一批操作分别进行加锁，然后到commit时再对事务里加的锁统一进行解锁；

  - InnoDB的事务是自动提交的：

    ```mysql
    show variables like 'autocommit'
    set autocommit = 0; # 不自动提交事务，仅适用于当前会话
    ```

  - InnoDB中的select默认是不加锁的，是非阻塞式select。

- InnoDB在sql没有用到索引时，使用的是表级锁，而在用到索引时，用到的是行级锁及get锁；

## MyISAM和InnoDB适合的场景

### MyISAM适合的场景

不支持事务，默认使用表级锁。

- 频繁执行全表count语句，因为它用额外的变量存储了表的行数；
- 对数据进行增删改的频率不高；
- 没有事务的场景。

### InnoDB适合的场景

支持事务，默认使用行级锁，支持表级锁。

- 增删改查都频繁；
- 可靠性要求比较高，要求支持事务的场景；