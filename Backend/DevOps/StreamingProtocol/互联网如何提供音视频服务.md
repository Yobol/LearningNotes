# 互联网是如何提供"音/视频"服务的？

## 多媒体信息

音/视频通常被统称为多媒体信息，与传统数据信息不同，它在内容上更加丰富多样，是由诸如文本、声音、图像等所形成的复合数据信息。

### 多媒体信息的特点

相较于传统数据信息，多媒体信息有以下两个主要的特点：

1. 信息量更大。`相应的对策是在传输/存储多媒体信息的过程中使用信息压缩技术。`

2. 在传输（隐含“边传输边播放”）时，对时延和时延抖动要求更高。

   - 模拟信号经过采样和模数转换后变为数字信号，然后再切分成多个分组进行传送；
   - 分组在发送端**等时传送**（发送的时间间隔恒定），进入互联网的速率也是恒定的；
   - 但由于互联网本身是非等时的（在使用IP协议的互联网中，每一个分组是独立地传送），因此，分组**非等时到达**接收端；

   如果在接收端对这些以非恒定速率到达的分组边接收边还原，那么就一定会产生很大的失真。`相应的对策是在接收端设置适当大小的缓存（应用层而非传输层TCP的缓存），当缓存中的分组数到达一定的数量后，再以恒定速率按顺序进行解析播放。`虽然使用缓存可以在消除*时延抖动（在播放时刻对应的分组尚未到达，即某个因网络出现时延而延迟到达的分组赶不上播放）*，但是会增加分组还原的时延（即增加播放时延，记为T）。

### 如何选择T

把T选得越大，消除时延抖动的效果就越好，但是会增加所有分组的平均播放时延，对于一些实时性要求较高的应用来说，这是非常不友好的。把T选得越小，消除时延抖动的效果就较差。

`在传输时延敏感的实时数据时，不仅传输时延不能太大，时延抖动也必须受到限制。`

### 如何消除传输误差

在互联网上传输实时数据的分组时，有可能出现差错甚至丢失。如果使用TCP协议进行分组重传，就会大大增加传输时延。`因此，实时数据的传输在传输层应该采用UDP协议，而不能使用TCP协议。即传输实时数据，宁可丢失少量数据，也不要太晚到达的数据。`

### 多媒体服务的类型

1. 流式存储音/视频。将已压缩的录制好的音/视频文件存储在服务器上，用户通过互联网下载。流式存储音/视频的特点是边下载边播放，即可以在（缓存）文件一部分后就开始连续播放。
2. 流式实况音/视频。流式实况音/视频的特点是基于互联网**边录制边发送 -> 边播放**，的一对多的通信。
3. 交互式音/视频。用户使用互联网和其他人进行实时交互式通信。

## 流式存储音/视频

传统的下载文件的方法：`Client Browser Request -> Server Response -> Client Media Player Parse & Play`。传统的下载方法最大缺点就是历时太长，必须要等到文件的全部内容下载完成后，才能调用播放器进行播放。

而媒体播放器的主要功能有：管理用户界面、解压缩、消除时延抖动和处理传输带来的差错。

相应地，有如下几种改进措施：

### 具有元文件的Web服务器

除了基础的音/视频文件外，还增加了描述这些文件重要信息的元文件：`Client Brower Request Meta File -> Web Server Response Meta File -> Client Browser Transport Meta File to Media Player Related to Format -> Client Media Player Request Multimedia File -> Web Server Response Multimedia File ->  Client Media Player Accept, Accumulate(Eliminate Delay Jitter), Parse & Play`。这样，由媒体播放器对媒体内容进行请求，就可以边下载缓存，边解析播放。

### 媒体服务器

为了更好地提供播放流式音/视频的服务，通常使用两个分开的服务器：普通的Web服务器用来响应元文件请求，媒体服务器用来响应音/视频文件请求：`Client Brower Request Meta File to Web Server -> Web Server Response Meta File -> Client Browser Transport Meta File to Media Player Related to Format -> Client Media Player Request Multimedia File to Media Server -> Media Server Response Multimedia File ->  Client Media Player Accept, Accumulate(Eliminate Delay Jitter), Parse & Play`。较之传统的Web服务器，媒体服务器是专门为播放流式音/视频文件而设计的，能够更加有效地为用户提供播放流式多媒体文件的服务。



传输媒体文件可以用TCP，也可以使用UDP。

- 使用TCP，可能会出现由于网络波动使得分组丢失或出错，而重传的分组不能按时到达接收端，使得媒体播放器播放不流畅的情况。
- 使用UDP，还是会受到网络时延的影响，防火墙可能会阻拦外部UDP分组的进入，如果想要使用RTP和RTSP协议来控制媒体的播放（如暂停、快进）会增加成本和复杂性。

相较而言，使用TCP传输流式媒体文件性价比可能更高。以下是使用TCP传输流式视频文件的步骤：

1. Web服务器遵循HTTP协议将视频文件传送到TCP发送缓存中，若缓存已填满，就暂时停止传送；
2. Web服务器按照TCP协议将TCP发送缓存中的数据发送到客户端的TCP接收缓存中，直到接收缓存被填满；
3. 客户端把视频数据传送到媒体播放器缓存区，当该缓存区的视频数据存储到一定程度时，就开始播放；
4. 客户端在播放时，媒体播放器等时地把视频数据按帧读出，然后解压显示。

实践证明，只要在步骤2的TCP平均传输速率达到视频节目规定的播放速率的两倍，媒体播放器一般就能流畅地播放网上的视频节目。

### 实时流式协议RTSP

RTSP（Real-Time Streaming Protocol，实时流式协议）。

RTSP协议以**C/S模式**工作，是一个**应用层**的**多媒体播放控制协议**，其本身并不传输数据，用来使用户能够**控制**从互联网上下载的实时数据。

和HTTP协议一样，RTSP的请求和响应报文都是ASCII文本，但不同点在于RTSP是有状态的，即RTSP会记录媒体播放器正在播放视频的状态：初始化/播放/暂停。RFC 2326规定，RTSP可以在TCP上传送，也可以在UDP上传送，但是没有规定具体的压缩方案、数据分组方案和缓存方案。

#### RTSP媒体服务器的工作流程

1. 客户端浏览器使用HTTP协议的GET请求向Web服务器请求音/视频文件；
2. Web服务器向客户端发送带有元文件的响应；
3. 客户端浏览器把收到的请求传送给媒体播放器；（1-3使用HTTP协议）
4. 媒体播放器的RTSP客户端发送`SETUP报文`与RTSP服务器建立连接；
5. 媒体播放器的RTSP服务器发送`RESPONSE报文`给RTSP客户端进行响应；
6. 媒体播放器的RTSP客户端发送`PLAY报文`请求下载音/视频文件（即开始播放）；
7. 媒体播放器的RTSP服务器发送`RESPONSE报文`给RTSP客户端进行响应；（4-7使用RTSP协议）
8. 传输音/视频流，用户可以随时`暂停（PAUSE报文）`、`继续播放（PLAY报文）`、快进或快退；（8使用RTP/RTCP协议）
9. 当用户不想继续观看时，可以由RTSP客户端发送`TREADOWN报文`断开连接；
10. 媒体播放器的RTSP服务器发送`RESPONSE报文`给RTSP客户端进行响应。（9-10使用RTSP协议）

## 流式实况音/视频

对于实况音/视频，优先考虑使用UDP协议来传输数据，丢失少量分组比播放暂停在该场景下对用户会更加友好。

## 交互式音/视频

### RTP

RTP（Real-time Transport Protocol，实时传输协议）。

### RTCP

RTCP（RTP Control Protocol，实时传输控制协议）。

## 如何提高服务质量